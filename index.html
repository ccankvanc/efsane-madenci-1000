<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Efsane Madenci: Deluxe</title>
    
    <link rel="icon" type="image/png" href="Efsane Madenci 1000 (1).png">
    <link rel="apple-touch-icon" href="Efsane Madenci 1000 (1).png">
    
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&display=swap');

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; background-color: #2c3e50;
            font-family: 'Rubik', sans-serif; overflow: hidden;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }

        #game-container {
            position: relative; width: 100%; height: 100%; max-width: 800px;
            background: #87CEEB; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI D√úZENƒ∞ --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: none; text-shadow: 1px 1px 0 #000; color: white; z-index: 5;
        }

        .ui-panel { display: flex; flex-direction: column; gap: 6px; width: 48%; }
        .ui-panel.left { align-items: flex-start; }
        .ui-panel.right { align-items: flex-end; }

        .stat-group { display: flex; gap: 6px; align-items: center; }

        .stat-box {
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; flex-direction: column; align-items: center;
            backdrop-filter: blur(2px);
            white-space: nowrap;
        }

        .stat-label { font-size: 10px; color: #ffd700; font-weight: bold; letter-spacing: 0.5px; margin-bottom: 2px; }
        .stat-value { font-size: 16px; font-weight: 900; line-height: 1; }

        .mini-bar-wrapper {
            width: auto; min-width: 100px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 6px;
            display: flex; align-items: center; gap: 6px;
            backdrop-filter: blur(2px);
            box-sizing: border-box;
        }

        .mini-bar-track {
            flex-grow: 1; height: 6px; background: rgba(255,255,255,0.2);
            border-radius: 3px; overflow: hidden; min-width: 50px;
        }

        .mini-bar-fill { height: 100%; width: 100%; border-radius: 3px; transition: width 0.3s ease; }
        #health-bar-fill { background: #e53935; box-shadow: 0 0 5px #e53935; }
        #storage-bar-fill { background: #4caf50; box-shadow: 0 0 5px #4caf50; }
        .mini-bar-text { font-size: 10px; font-weight: bold; min-width: 25px; text-align: right; }

        .icon-btn {
            pointer-events: auto; background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255,255,255,0.3); color: white;
            width: 40px; height: 40px; border-radius: 8px;
            font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s; margin: 0; padding: 0;
        }
        .icon-btn:hover { background: #f44336; transform: scale(1.05); }
        .icon-btn:active { transform: scale(0.95); }

        @media (max-width: 480px) {
            #ui-layer { padding: 5px; padding-top: max(5px, env(safe-area-inset-top)); }
            .ui-panel { gap: 4px; }
            .stat-group { gap: 4px; }
            .stat-box { padding: 3px 6px; }
            .stat-label { font-size: 8px; }
            .stat-value { font-size: 13px; }
            .mini-bar-wrapper { padding: 2px 5px; min-width: 80px; }
            .mini-bar-track { height: 4px; min-width: 30px; }
            .mini-bar-text { font-size: 9px; }
            .icon-btn { width: 32px; height: 32px; font-size: 16px; }
            .booster-icon { width: 20px; height: 20px; font-size: 12px; }
            h1 { font-size: 32px; }
            h2 { font-size: 22px; }
        }

        #active-boosters { display: flex; gap: 4px; margin-top: 2px; }
        .booster-icon {
            font-size: 14px; background: rgba(0,0,0,0.6); border-radius: 50%;
            width: 24px; height: 24px; display: flex; justify-content: center; align-items: center;
            border: 1px solid #ffd700; box-shadow: 0 0 3px #ffd700; cursor: help;
        }

        /* Men√ºler */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; color: white; backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }

        h1 { font-size: 36px; margin-bottom: 5px; color: #ffd700; text-shadow: 3px 3px 0 #d35400; text-align: center; font-weight: 900; }
        h2 { font-size: 24px; margin-bottom: 15px; color: #fff; font-weight: 700; }
        p { font-size: 14px; margin: 8px; text-align: center; max-width: 85%; color: #ccc; line-height: 1.4; }

        button.main-btn {
            background: linear-gradient(to bottom, #ff9800, #e65100);
            border: none; border-bottom: 4px solid #bf360c; color: white;
            padding: 12px 40px; font-size: 18px; font-family: 'Rubik', sans-serif; font-weight: bold;
            border-radius: 25px; cursor: pointer; margin-top: 15px; transition: all 0.1s;
        }
        button.main-btn:active { transform: translateY(4px); border-bottom: 0px solid transparent; margin-bottom: 5px; }
        
        button.secondary-btn {
            background: #455a64; border: none; border-bottom: 3px solid #263238; color: white;
            padding: 8px 25px; font-size: 14px; font-family: 'Rubik', sans-serif; font-weight: bold;
            border-radius: 15px; cursor: pointer; margin-top: 10px;
        }

        /* Market */
        .shop-container {
            display: flex; flex-direction: column; background: #2c3e50; padding: 15px;
            border-radius: 15px; border: 3px solid #ffd700; width: 95%; max-width: 500px;
            max-height: 75vh; overflow-y: auto;
        }
        .shop-tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .tab-btn {
            background: #455a64; padding: 8px 10px; font-size: 11px; border-bottom: 3px solid #263238;
            margin: 0; flex: 1; color: #fff; border: none; cursor: pointer; border-radius: 5px 5px 0 0; min-width: 60px;
        }
        .tab-btn.active { background: #ffd700; color: #333; border-bottom: 3px solid #f57f17; }
        .shop-section { display: none; width: 100%; }
        .shop-section.active { display: block; }
        .upgrade-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
        
        .item-card {
            background: #37474f; border: 2px solid #546e7a; border-radius: 8px; padding: 8px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .item-card:hover { border-color: #ffd700; }
        .item-card.purchased { border-color: #4caf50; opacity: 0.8; }
        .item-icon { font-size: 24px; margin-bottom: 3px; height: 35px; display: flex; align-items: center; justify-content: center; }
        .item-icon svg { width: 100%; height: 100%; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .item-name { font-size: 12px; font-weight: bold; margin-bottom: 2px; color: #fff; }
        .item-desc { font-size: 9px; color: #aaa; margin-bottom: 4px; min-height: 20px; display: flex; align-items: center; justify-content: center; }
        .item-price { font-size: 12px; color: #ffd700; font-weight: bold; }
        
        .buy-btn {
            padding: 4px 8px; font-size: 11px; margin-top: 4px; width: 100%; background: #0288d1;
            border-bottom: 3px solid #01579b; color: #fff; border: none; cursor: pointer; border-radius: 4px;
        }
        .buy-btn:disabled { background: #555; border-bottom: 3px solid #333; color: #999; cursor: not-allowed; }
        .buy-btn.equipped { background: #4caf50; border-bottom: 3px solid #2e7d32; pointer-events: none; }

        /* Nasƒ±l Oynanƒ±r */
        #tutorial-screen { text-align: left; }
        .tutorial-content {
            background: #3e2723; padding: 20px; border-radius: 15px; border: 2px solid #8d6e63;
            width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto; color: #fff;
        }
        .tut-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tut-icon { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .tut-icon svg { width: 100%; height: 100%; }
        .tut-text h3 { margin: 0 0 5px 0; color: #ffd700; font-size: 16px; }
        .tut-text p { margin: 0; font-size: 13px; color: #ccc; text-align: left; max-width: 100%; }

        #messages {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 28px; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.8);
            pointer-events: none; opacity: 0; transition: opacity 0.5s, transform 0.5s;
            z-index: 15; text-align: center; width: 100%; font-weight: 900;
        }
        
        /* Harita */
        .map-container {
            width: 85%; max-width: 350px; height: 50vh; background: #3e2723;
            border: 3px solid #8d6e63; border-radius: 12px; overflow-y: auto;
            position: relative; padding: 15px; box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
        }
        .map-path { display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; padding-bottom: 15px; }
        .map-node {
            width: 50px; height: 50px; background: #5d4037; border-radius: 50%; border: 2px solid #8d6e63;
            display: flex; justify-content: center; align-items: center; color: #aaa;
            font-weight: bold; font-size: 16px; position: relative; z-index: 2;
        }
        .map-node::after {
            content: ''; position: absolute; top: 100%; left: 50%; width: 3px; height: 18px;
            background: #8d6e63; transform: translateX(-50%); z-index: -1;
        }
        .map-node:last-child::after { display: none; }
        .map-node.completed { background: #4caf50; border-color: #2e7d32; color: white; cursor: pointer; }
        .map-node.completed:hover { background: #689f38; }
        .map-node.current {
            background: #ffd700; border-color: #ff6f00; color: #3e2723;
            transform: scale(1.2); box-shadow: 0 0 10px #ffd700; animation: pulseNode 1.5s infinite; cursor: pointer;
        }

        /* --- MINI GAME (AT√ñLYE) --- */
        #mini-game-screen { background: rgba(0, 0, 0, 0.95); }
        .mini-game-container {
            position: relative; width: 300px; height: 450px; background: #2c3e50; border: 4px solid #ffd700; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; padding: 20px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
        }
        .mg-title { font-size: 24px; color: #ffd700; margin-bottom: 20px; font-weight: bold; text-align: center; }
        .mg-reward-showcase {
            height: 100px; width: 100%; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;
        }
        .mg-reward-showcase svg {
            width: 80px; height: 80px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .mg-bar-container {
            width: 100%; height: 30px; background: #333; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #555; margin-bottom: 30px;
        }
        .mg-zone { height: 100%; position: absolute; top: 0; }
        .mg-zone.red { background: #e53935; width: 100%; left: 0; }
        .mg-zone.yellow { background: #ffeb3b; width: 50%; left: 25%; }
        .mg-zone.green { background: #4caf50; width: 20%; left: 40%; box-shadow: 0 0 10px #4caf50; }
        .mg-needle {
            width: 4px; height: 100%; background: #fff; position: absolute; top: 0; left: 50%; box-shadow: 0 0 5px #000; z-index: 2;
        }
        .menu-logo { font-size: 60px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div class="ui-panel left">
                <div class="stat-group">
                    <div class="stat-box" style="min-width: 70px;">
                        <span class="stat-label">HEDEF</span>
                        <span class="stat-value" id="target-display">0 / 500</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">SEVƒ∞YE</span>
                        <span class="stat-value" id="level-display">1</span>
                    </div>
                </div>
                <div class="mini-bar-wrapper">
                    <span class="mini-bar-icon">‚ù§Ô∏è</span>
                    <div class="mini-bar-track"><div class="mini-bar-fill" id="health-bar-fill"></div></div>
                    <span class="mini-bar-text" id="health-text-mini">100</span>
                </div>
                <div id="active-boosters"></div>
            </div>

            <div class="ui-panel right">
                <div class="stat-group">
                    <div class="stat-box">
                        <span class="stat-label">C√úZDAN</span>
                        <span class="stat-value">$<span id="current-score">0</span></span>
                    </div>
                    <button id="pause-btn" class="icon-btn" title="Oyunu Durdur">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                </div>
                <div class="mini-bar-wrapper">
                    <span class="mini-bar-icon">üéí</span>
                    <div class="mini-bar-track"><div class="mini-bar-fill" id="storage-bar-fill"></div></div>
                    <span class="mini-bar-text" id="storage-text-mini">0%</span>
                </div>
            </div>
        </div>

        <div id="messages"></div>

        <div id="main-menu" class="overlay">
            <div class="menu-logo">‚õèÔ∏èüíé</div>
            <h1>EFSANE MADENCƒ∞</h1>
            <p style="color:#ffd700; font-weight:bold;">DELUXE EDITION</p>
            <div style="display:flex; gap:10px; flex-direction:column; width:200px;">
                <button id="play-btn" class="main-btn" style="margin-top:0;">OYNA</button>
                <button id="main-market-btn" class="secondary-btn" style="background:#0288d1; border-bottom-color:#01579b;">MARKET & KOST√úM</button>
                <button id="tutorial-btn" class="secondary-btn" style="background:#7b1fa2; border-bottom-color:#4a148c;">NASIL OYNANIR?</button>
            </div>
            <button id="main-reset-btn" class="secondary-btn" style="background:#555; font-size:10px; margin-top:20px; padding:5px 15px;">ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
        </div>

        <div id="tutorial-screen" class="overlay hidden">
            <h2 style="color:#ffd700">NASIL OYNANIR?</h2>
            <div class="tutorial-content">
                <div class="tut-item"><div class="tut-icon"><svg viewBox="0 0 50 50"><path d="M15 10 L15 35 C15 45 35 45 35 35 L35 10" stroke="#ffd700" stroke-width="4" fill="none" stroke-linecap="round"/></svg></div><div class="tut-text"><h3>Kancayƒ± Fƒ±rlat</h3><p>Ekrana dokunarak veya tƒ±klayarak sallanan kancayƒ± fƒ±rlat. Altƒ±nlarƒ± ve elmaslarƒ± hedefle.</p></div></div>
                <div class="tut-item"><div class="tut-icon"><svg viewBox="0 0 50 50"><path d="M10 20 L20 10 L40 15 L45 35 L25 45 L5 35 Z" fill="#7f8c8d" stroke="#555" stroke-width="2"/></svg></div><div class="tut-text"><h3>Ta≈ülardan Ka√ßƒ±n!</h3><p>Ta≈ülar deƒüersizdir ve kancanƒ±n <b>canƒ±nƒ± azaltƒ±r</b>. √áok b√ºy√ºk ta≈ülar kancanƒ± kƒ±rabilir!</p></div></div>
                <div class="tut-item"><div class="tut-icon"><svg viewBox="0 0 50 50"><text x="10" y="35" font-size="30">üß®</text></svg></div><div class="tut-text"><h3>Dinamit ve TNT</h3><p>Ta≈ülara dokunarak patlatabilirsin. <b>TNT varillerine Dƒ∞KKAT ET!</b> Vurursan patlar ve b√ºy√ºk hasar verir.</p></div></div>
                <div class="tut-item"><div class="tut-icon"><svg viewBox="0 0 50 50"><text x="10" y="35" font-size="30">üî®</text></svg></div><div class="tut-text"><h3>M√ºcevher At√∂lyesi</h3><p>Her 10 b√∂l√ºmde bir a√ßƒ±lƒ±r. ƒ∞breyi ye≈üilde durdurursan b√ºy√ºk √∂d√ºl kazanƒ±rsƒ±n!</p></div></div>
            </div>
            <button id="close-tutorial-btn" class="main-btn" style="margin-top:15px;">ANLADIM</button>
        </div>

        <div id="mini-game-screen" class="overlay hidden">
            <div class="mini-game-container">
                <div class="mg-title">M√úCEVHER AT√ñLYESƒ∞</div>
                <div id="mg-reward-showcase" class="mg-reward-showcase"><div style="font-size:50px;">üíé</div></div>
                <p style="font-size:14px; margin-bottom:15px; color:#ccc;">ƒ∞breyi ye≈üil alanda durdur!</p>
                <div class="mg-bar-container"><div class="mg-zone red"></div><div class="mg-zone yellow"></div><div class="mg-zone green"></div><div class="mg-needle" id="mg-needle"></div></div>
                <button id="mg-hit-btn" class="main-btn" style="width:100%; margin-top:0;">ƒ∞≈ûLE!</button>
                <p id="mg-result-text" style="height:20px; margin-top:10px; font-weight:bold; color:#fff; text-align:center; font-size:16px;"></p>
            </div>
        </div>

        <div id="start-screen" class="overlay hidden">
            <h2 id="level-title">SEVƒ∞YE 1</h2>
            <p>Ta≈ülar kancana zarar verir!</p>
            <p>Deponu sadece altƒ±nlarla doldur.</p>
            <div id="pre-boosters-info" style="display:flex; gap:10px; margin: 10px 0; justify-content:center; align-items:center;"></div>
            <p id="dynamite-hint" style="color:#ff5722; font-size:14px; display:none;">üí° ƒ∞PUCU: Ta≈üa dokunarak patlatabilirsin!</p>
            <button id="start-level-btn" class="main-btn">MADENE ƒ∞N</button>
            <button id="map-btn-start" class="secondary-btn">üó∫Ô∏è HARƒ∞TAYA BAK</button>
        </div>

        <div id="pause-screen" class="overlay hidden">
            <h2 style="color:#ffd700">OYUN DURAKLATILDI</h2>
            <button id="resume-btn" class="main-btn">DEVAM ET</button>
            <button id="pause-restart-btn" class="secondary-btn" style="background: #FF9800; border-bottom-color: #E65100;">B√ñL√úM√ú YENƒ∞DEN BA≈ûLAT</button>
            <button id="map-btn-pause" class="secondary-btn">üó∫Ô∏è HARƒ∞TA</button>
            <button id="main-menu-btn" class="secondary-btn" style="background: #f44336; border-bottom-color: #d32f2f;">ANA MEN√úYE D√ñN</button>
        </div>

        <div id="map-screen" class="overlay hidden">
            <h2 style="color:#ffd700; margin-bottom:10px;">ƒ∞LERLEME HARƒ∞TASI</h2>
            <div class="map-container"><div id="map-content" class="map-path"></div></div>
            <button id="close-map-btn" class="main-btn" style="margin-top:15px; padding:10px 40px;">KAPAT</button>
        </div>

        <div id="shop-screen" class="overlay hidden">
            <h2 id="shop-title" style="color:#ffd700">SEVƒ∞YE TAMAMLANDI!</h2>
            <p id="shop-message">Sonraki b√∂l√ºme hazƒ±rlan.</p>
            <div class="shop-container">
                <div class="shop-tabs">
                    <button class="tab-btn active" onclick="switchTab('upgrades')">G√ú√áLENDƒ∞R</button>
                    <button class="tab-btn" onclick="switchTab('boosters')">DESTEK</button>
                    <button class="tab-btn" onclick="switchTab('skins')">KANCA</button>
                    <button class="tab-btn" onclick="switchTab('miner_skins')">KOST√úM</button>
                </div>
                <div id="tab-upgrades" class="shop-section active">
                    <div class="upgrade-grid">
                        <div class="item-card"><div class="item-icon">‚ö°</div><div class="item-name">Hƒ±zlƒ± √áekim</div><div class="item-desc">√áekme hƒ±zƒ± artar</div><div class="item-price" id="price-power">$100</div><button class="buy-btn" id="btn-power">SATIN AL (+%10)</button></div>
                        <div class="item-card"><div class="item-icon">üì¶</div><div class="item-name">Geni≈ü Depo</div><div class="item-desc">Daha fazla altƒ±n</div><div class="item-price" id="price-storage">$150</div><button class="buy-btn" id="btn-storage">SATIN AL (+20kg)</button></div>
                    </div>
                </div>
                <div id="tab-boosters" class="shop-section">
                    <div class="upgrade-grid">
                        <div class="item-card"><div class="item-icon">üß®</div><div class="item-name">Dinamit</div><div class="item-desc">Ta≈üa dokun patlat.</div><div class="item-price" id="price-dynamite">$200</div><button class="buy-btn" id="btn-boost-dynamite">SATIN AL (1 Adet)</button></div>
                        <div class="item-card"><div class="item-icon">üí™</div><div class="item-name">G√º√ß ƒ∞ksiri</div><div class="item-desc">B√∂l√ºmde %50 hƒ±z.</div><div class="item-price" id="price-strength">$300</div><button class="buy-btn" id="btn-boost-strength">SATIN AL (1 Adet)</button></div>
                        <div class="item-card"><div class="item-icon">üíé</div><div class="item-name">Elmas Cilasƒ±</div><div class="item-desc">Elmas %50 deƒüerli.</div><div class="item-price" id="price-polish">$150</div><button class="buy-btn" id="btn-boost-polish">SATIN AL (1 Adet)</button></div>
                    </div>
                </div>
                <div id="tab-skins" class="shop-section"><div class="upgrade-grid" id="skin-grid"></div></div>
                <div id="tab-miner_skins" class="shop-section"><div class="upgrade-grid" id="miner-skin-grid"></div></div>
            </div>
            <button id="next-level-btn" class="main-btn" style="background: #4caf50; border-bottom-color: #2e7d32;">SONRAKƒ∞ SEVƒ∞YE >></button>
        </div>

        <div id="game-over-screen" class="overlay hidden">
            <h1 style="color: #f44336;">OYUN Bƒ∞TTƒ∞!</h1>
            <p id="game-over-reason">Hedefe ula≈üamadƒ±n.</p>
            <h2 id="final-score">Kasa: $0</h2>
            <button id="restart-level-btn" class="main-btn">TEKRAR DENE</button>
            <button id="game-over-main-btn" class="secondary-btn" style="margin-top:10px;">ANA MEN√ú</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- MOBƒ∞L UYUMLULUK YAMASI (Polyfill) ---
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };
        }

        // UI
        const ui = {
            money: document.getElementById('current-score'),
            targetDisplay: document.getElementById('target-display'),
            level: document.getElementById('level-display'),
            storageTextMini: document.getElementById('storage-text-mini'),
            storageBar: document.getElementById('storage-bar-fill'),
            healthTextMini: document.getElementById('health-text-mini'),
            healthBar: document.getElementById('health-bar-fill'),
            messages: document.getElementById('messages'),
            shopTitle: document.getElementById('shop-title'),
            shopMsg: document.getElementById('shop-message'),
            pricePower: document.getElementById('price-power'),
            priceStorage: document.getElementById('price-storage'),
            skinGrid: document.getElementById('skin-grid'),
            minerSkinGrid: document.getElementById('miner-skin-grid'),
            pauseScreen: document.getElementById('pause-screen'),
            mapScreen: document.getElementById('map-screen'),
            mapContent: document.getElementById('map-content'),
            shopScreen: document.getElementById('shop-screen'),
            mainMenu: document.getElementById('main-menu'),
            startScreen: document.getElementById('start-screen'),
            tutorialScreen: document.getElementById('tutorial-screen'),
            miniGameScreen: document.getElementById('mini-game-screen'),
            mgRewardShowcase: document.getElementById('mg-reward-showcase'),
            activeBoosters: document.getElementById('active-boosters'),
            preBoostersInfo: document.getElementById('pre-boosters-info'),
            dynamiteHint: document.getElementById('dynamite-hint'),
            priceDynamite: document.getElementById('price-dynamite'),
            priceStrength: document.getElementById('price-strength'),
            pricePolish: document.getElementById('price-polish')
        };

        const hookSkins = [
            { id: 'default', name: 'Paslƒ± Kanca', price: 0, color: '#555', type: 'basic', durability: 100 },
            { id: 'golden', name: 'Altƒ±n Kanca', price: 1500, color: '#FFD700', type: 'fancy', durability: 200 },
            { id: 'diamond', name: 'Elmas U√ßlu', price: 3500, color: '#00FFFF', type: 'sharp', durability: 350 },
            { id: 'laser', name: 'Lazer Kƒ±ska√ß', price: 8000, color: '#FF0055', type: 'neon', durability: 600, special: 'laser' },
            { id: 'plasma', name: 'Plazma Kanca', price: 15000, color: '#76ff03', type: 'neon', durability: 1000 },
            { id: 'void', name: 'Kara Delik', price: 1000000, color: '#e040fb', type: 'neon', durability: 2000, special: 'blackhole' },
            { id: 'magnet', name: 'Mƒ±knatƒ±s K.', price: 45000, color: '#ff3d00', type: 'fancy', durability: 1500, special: 'magnet' },
            { id: 'time', name: 'Zaman Kancasƒ±', price: 90000, color: '#2979ff', type: 'sharp', durability: 1800, special: 'time' },
            { id: 'infinity', name: 'Sonsuzluk', price: 250000, color: '#ffd600', type: 'neon', durability: 3000, special: 'infinity' }
        ];

        const minerSkins = [
            { id: 'default', name: 'Klasik', price: 0, shirt: '#1565C0', hat: '#FFC107', pants: '#0D47A1' },
            { id: 'business', name: 'ƒ∞≈ü Adamƒ±', price: 5000, shirt: '#212121', hat: '#424242', pants: '#000000' },
            { id: 'ninja', name: 'Ninja', price: 8000, shirt: '#1a237e', hat: '#000000', pants: '#1a237e' },
            { id: 'santa', name: 'Noel Baba', price: 10000, shirt: '#d32f2f', hat: '#ff5252', pants: '#d32f2f' },
            { id: 'alien', name: 'Marslƒ±', price: 15000, shirt: '#4caf50', hat: '#76ff03', pants: '#2e7d32' },
            { id: 'pirate', name: 'Korsan', price: 20000, shirt: '#5d4037', hat: '#b71c1c', pants: '#3e2723' },
            { id: 'cyborg', name: 'Sayborg', price: 45000, shirt: '#607d8b', hat: '#b0bec5', pants: '#455a64' },
            { id: 'wizard', name: 'B√ºy√ºc√º', price: 80000, shirt: '#4a148c', hat: '#7b1fa2', pants: '#311b92' },
            { id: 'king', name: 'Kral', price: 150000, shirt: '#b71c1c', hat: '#FFD700', pants: '#880e4f' },
            { id: 'golden_boy', name: 'Bay Altƒ±n', price: 500000, shirt: '#FFD700', hat: '#FFECB3', pants: '#FFD700' }
        ];

        const defaultState = {
            level: 1, money: 0, levelScore: 0, levelTarget: 500, maxStorage: 100,
            hookSpeed: 2, hookPower: 1, 
            currentSkinId: 'default', unlockedSkins: ['default'],
            currentMinerSkinId: 'default', unlockedMinerSkins: ['default'],
            prices: { power: 100, storage: 150 },
            activeBoosters: { dynamite: false, strength: false, polish: false },
            levelMoneyStart: 0,
            tutorialSeen: false
        };

        let gameState = JSON.parse(JSON.stringify(defaultState));
        let levelStartState = null; 
        
        let sessionState = {
            storage: 0, currentHealth: 100, maxHealth: 100,
            isShopping: false, isPaused: false, isMapOpen: false, levelEnding: false, inMenu: true,
            inMiniGame: false, playingLevel: 1, shopMode: 'level' 
        };

        let mg = {
            active: false, pos: 50, dir: 1, speed: 1.5,
            needleEl: document.getElementById('mg-needle'),
            resultEl: document.getElementById('mg-result-text'),
            btn: document.getElementById('mg-hit-btn'),
            animId: null
        };

        let objects = [];
        let particles = [];
        let miner = null;
        let hook = null;
        let mole = null;
        let gameLoopRunning = false;
        
        const CUSTOM_MINER_IMAGE_URL = 'image_cd5845.jpg'; 
        
        // ASSET LOADER
        const assets = {
            gold: { src: 'gold.png', img: new Image(), loaded: false },
            rock: { src: 'rock.png', img: new Image(), loaded: false },
            diamond: { src: 'diamond.png', img: new Image(), loaded: false },
            mole: { src: 'mole.png', img: new Image(), loaded: false },
            miner: { src: 'miner.png', img: new Image(), loaded: false },
            background: { src: 'background.png', img: new Image(), loaded: false },
            dynamite: { src: 'dynamite.png', img: new Image(), loaded: false }
        };

        Object.keys(assets).forEach(key => {
            assets[key].img.src = assets[key].src;
            assets[key].img.onload = () => { assets[key].loaded = true; };
        });

        // --- YARDIMCI FONKSƒ∞YONLAR ---
        function getSkinDurability(skinId) { const s = hookSkins.find(x => x.id === skinId); return s ? s.durability : 100; }
        
        function getHookSVG(type, color) { 
            let path = ""; let filter = "";
            if (type === 'basic' || type === 'fancy') path = `<path d="M15 10 L15 35 C15 45 35 45 35 35 L35 10" stroke="${color}" stroke-width="6" fill="none" stroke-linecap="round"/><circle cx="25" cy="8" r="4" fill="${color}"/>`;
            else if (type === 'sharp') path = `<path d="M10 10 L25 40 L40 10" stroke="${color}" stroke-width="5" fill="none" stroke-linejoin="miter"/><circle cx="25" cy="40" r="3" fill="#fff"/>`;
            else if (type === 'neon') { path = `<path d="M15 15 L15 35 L25 40 L35 35 L35 15" stroke="${color}" stroke-width="4" fill="none"/><path d="M10 20 L40 20" stroke="${color}" stroke-width="2"/>`; filter = `filter: drop-shadow(0 0 5px ${color});`; }
            return `<svg viewBox="0 0 50 50" style="${filter}">${path}</svg>`;
        }

        function getMinerSVG(shirt, hat) {
            return `<svg viewBox="0 0 50 50"><rect x="15" y="20" width="20" height="20" fill="${shirt}" rx="5"/><circle cx="25" cy="15" r="8" fill="#ffcc80"/><path d="M15 10 Q25 5 35 10" stroke="${hat}" stroke-width="8" fill="none"/></svg>`;
        }

        function getRewardSVG(type) {
            if (type === 'necklace') return `<svg viewBox="0 0 50 50"><circle cx="25" cy="25" r="18" stroke="#FFD700" stroke-width="2" fill="none"/><path d="M25 43 L20 30 L30 30 Z" fill="#FFD700"/><circle cx="25" cy="38" r="5" fill="#00FFFF" stroke="#fff" stroke-width="1"/></svg>`;
            if (type === 'bracelet') return `<svg viewBox="0 0 50 50"><ellipse cx="25" cy="25" rx="20" ry="12" stroke="#C0C0C0" stroke-width="5" fill="none"/><rect x="22" y="10" width="6" height="6" fill="#E91E63"/></svg>`;
            return `<svg viewBox="0 0 50 50"><path d="M25 5 L25 20" stroke="#FFD700" stroke-width="2"/><circle cx="25" cy="25" r="8" fill="#FF5252"/></svg>`;
        }

        function resize() {
            const container = document.getElementById('game-container');
            if (container) {
                canvas.width = container.clientWidth; canvas.height = container.clientHeight;
                if(hook) hook.x = canvas.width / 2; 
                if(miner) miner.x = canvas.width / 2 + 70;
            }
        }

        function showMessage(text, color) {
            ui.messages.innerText = text; ui.messages.style.color = color; ui.messages.style.opacity = 1; ui.messages.style.transform = "translate(-50%, -50%) scale(1.2)";
            setTimeout(() => { ui.messages.style.opacity = 0; ui.messages.style.transform = "translate(-50%, -50%) scale(1)"; }, 800);
        }

        function activateBlackHole(centerX, centerY) {
            for(let i=0; i<30; i++) {
                particles.push({
                    x: centerX + (Math.random()-0.5)*300, y: centerY + (Math.random()-0.5)*300, 
                    vx: (centerX - (centerX + (Math.random()-0.5)*300)) * 0.05,
                    vy: (centerY - (centerY + (Math.random()-0.5)*300)) * 0.05,
                    life: 2.0, color: '#e040fb'
                });
            }
            objects.forEach((obj, index) => {
                if (obj.collected) return;
                let dist = Math.hypot(obj.x - centerX, obj.y - centerY);
                if (dist < 200) { 
                    obj.collected = true; 
                    if (obj.type === 'rock' || obj.type === 'tnt') { 
                        createExplosion(obj.x, obj.y); 
                    } else {
                        let val = obj.value;
                        if (obj.type === 'diamond' && gameState.activeBoosters.polish) val = Math.floor(val * 1.5);
                        gameState.money += val; gameState.levelScore += val; sessionState.storage += 0.1;
                        createExplosion(obj.x, obj.y); 
                    }
                }
            });
            showMessage("KARA DELƒ∞K!", "#e040fb");
            updateUI();
        }

        // --- SINIFLAR ---
        class Miner {
            constructor() {
                this.x = 0; this.y = 45; this.armAngle = 0; this.waveSpeed = 0.1; 
                this.mood = 'normal'; this.waveTimer = 0; this.image = new Image(); 
                this.imageLoaded = false;
                
                if(CUSTOM_MINER_IMAGE_URL && CUSTOM_MINER_IMAGE_URL.trim() !== '') {
                    this.image.src = CUSTOM_MINER_IMAGE_URL;
                    this.image.onload = () => { this.imageLoaded = true; };
                    this.image.onerror = () => { this.imageLoaded = false; };
                }
            }
            update() { 
                this.waveTimer += this.waveSpeed; 
                if (this.mood === 'happy') { this.armAngle = Math.sin(this.waveTimer * 3) * 0.5 - 2.5; if (this.waveTimer > 10) this.mood = 'normal'; } 
                else { if (Math.sin(this.waveTimer * 0.05) > 0.8) this.armAngle = Math.sin(this.waveTimer) * 0.3 - 2.5; else this.armAngle = -2.5; } 
            }
            draw() { 
                if (assets.miner.loaded) { 
                    ctx.save(); ctx.translate(this.x, this.y); ctx.scale(-1, 1); 
                    ctx.drawImage(assets.miner.img, -35, 0, 70, 90); ctx.restore(); 
                } else { this.drawDefaultMiner(); }
            }
            drawDefaultMiner() {
                const skin = minerSkins.find(s => s.id === gameState.currentMinerSkinId) || minerSkins[0];
                ctx.save(); ctx.translate(this.x, this.y); ctx.scale(-1, 1); 
                ctx.save(); ctx.translate(14, 25); ctx.rotate(0.5); ctx.fillStyle = skin.shirt; ctx.fillRect(-4, 0, 8, 20); ctx.fillStyle = '#ffcc80'; ctx.beginPath(); ctx.arc(0, 20, 5, 0, Math.PI*2); ctx.fill(); ctx.restore();
                ctx.fillStyle = skin.pants; ctx.fillRect(-8, 45, 10, 25); ctx.fillRect(8, 45, 10, 25); ctx.fillStyle = '#3E2723'; ctx.fillRect(-10, 68, 14, 6); ctx.fillRect(6, 68, 14, 6); 
                ctx.fillStyle = skin.shirt; ctx.beginPath(); if(ctx.roundRect) ctx.roundRect(-15, 20, 30, 30, 5); else ctx.rect(-15, 20, 30, 30); ctx.fill();
                ctx.fillStyle = '#ffcc80'; ctx.beginPath(); ctx.ellipse(0, 10, 11, 13, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#5D4037'; ctx.beginPath(); ctx.arc(0, 12, 11, 0, Math.PI, false); ctx.fill(); ctx.fillRect(-6, 12, 12, 3);
                ctx.fillStyle = skin.hat; ctx.beginPath(); ctx.arc(0, 5, 12, Math.PI, 0); ctx.lineTo(16, 5); ctx.lineTo(-14, 5); ctx.fill();
                ctx.save(); ctx.translate(-13, 22); ctx.rotate(this.armAngle); ctx.fillStyle = skin.shirt; ctx.fillRect(-4, 0, 8, 22); ctx.translate(0, 22); ctx.fillStyle = '#ffcc80'; ctx.beginPath(); ctx.arc(0, 2, 6, 0, Math.PI*2); ctx.fill(); ctx.restore();
                ctx.restore();
            }
        }

        class Hook {
            constructor() { 
                this.x = 0; 
                this.y = 80; 
                this.angle = 0; 
                this.angleSpeed = 0.015; 
                this.length = 50; 
                this.state = 'swing'; 
                this.targetObj = null; 
            }
            update() {
                if (this.state === 'swing') { this.angle += this.angleSpeed; if (this.angle > 1.3 || this.angle < -1.3) this.angleSpeed *= -1; }
                else if (this.state === 'shoot') {
                    this.length += gameState.hookSpeed * 2.0; 
                    if (this.length > canvas.height * 1.3 || this.x + Math.sin(this.angle) * this.length < 0 || this.x + Math.sin(this.angle) * this.length > canvas.width) this.state = 'pull';
                    let tipX = this.x + Math.sin(this.angle) * this.length; let tipY = this.y + Math.cos(this.angle) * this.length;
                    
                    if (mole.active && !mole.caught && Math.hypot(tipX - mole.x, tipY - mole.y) < 30) {
                        this.targetObj = mole; this.state = 'pull'; mole.caught = true; miner.mood = 'happy'; miner.waveTimer = 0; return;
                    }

                    for (let obj of objects) { if (!obj.collected && Math.hypot(tipX - obj.x, tipY - obj.y) < obj.radius) { this.targetObj = obj; this.state = 'pull'; obj.caught = true; miner.mood = 'happy'; miner.waveTimer = 0; break; } }
                } else if (this.state === 'pull') {
                    if (this.targetObj && this.targetObj.caught) {
                        const currentSkin = hookSkins.find(s => s.id === gameState.currentSkinId);
                        if (currentSkin && currentSkin.special === 'blackhole' && !this.targetObj.blackholed) {
                            this.targetObj.blackholed = true; activateBlackHole(this.targetObj.x, this.targetObj.y);
                        } else if (currentSkin && currentSkin.special === 'laser' && this.targetObj.type === 'rock') {
                            this.state = 'shoot'; 
                            this.targetObj.collected = true; 
                            createExplosion(this.targetObj.x, this.targetObj.y);
                            showMessage("Lazer!", "#FF0055");
                            this.targetObj = null; 
                            return; 
                        } else if (this.targetObj.type === 'tnt') {
                             // TNT always explodes, even with laser hook
                            createExplosion(this.targetObj.x, this.targetObj.y);
                            this.targetObj.collected = true;
                            collectObject(this.targetObj); // Handle damage in collectObject
                            this.targetObj = null;
                            this.state = 'pull'; // Hook returns damaged
                            return;
                        }
                        
                        // Mƒ±knatƒ±s Skill
                        if (currentSkin && (currentSkin.special === 'magnet' || currentSkin.special === 'infinity')) {
                            objects.forEach(o => {
                                if (!o.collected && o.type !== 'rock' && o.type !== 'tnt' && Math.hypot(this.x - o.x, this.y - o.y) < 100) {
                                    o.x += (this.x - o.x) * 0.1;
                                    o.y += (this.y - o.y) * 0.1;
                                    if (Math.hypot(this.x - o.x, this.y - o.y) < 20) { o.collected = true; collectObject(o); }
                                }
                            });
                        }
                    }
                    
                    let pullSpeed = gameState.hookSpeed;
                    if (this.targetObj) {
                        let weightFactor = this.targetObj.weight / gameState.hookPower;
                        let speedMult = gameState.activeBoosters.strength ? 1.5 : 1.0;
                        const currentSkin = hookSkins.find(s => s.id === gameState.currentSkinId);
                        if (currentSkin && (currentSkin.special === 'time' || currentSkin.special === 'infinity')) speedMult *= 1.5;

                        pullSpeed = Math.max(0.5, (gameState.hookSpeed * (15 / (weightFactor + 10))) * speedMult);
                        this.targetObj.x = this.x + Math.sin(this.angle) * this.length; this.targetObj.y = this.y + Math.cos(this.angle) * this.length;
                    } else { pullSpeed = gameState.hookSpeed * 4; }
                    this.length -= pullSpeed;
                    if (this.length <= 50) { this.length = 50; this.state = 'swing'; if (this.targetObj) { collectObject(this.targetObj); this.targetObj = null; } }
                }
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(Math.sin(this.angle) * this.length, Math.cos(this.angle) * this.length); ctx.lineWidth = 2; ctx.strokeStyle = '#222'; ctx.stroke();
                ctx.translate(Math.sin(this.angle) * this.length, Math.cos(this.angle) * this.length); ctx.rotate(-this.angle);
                let currentSkin = hookSkins.find(s => s.id === gameState.currentSkinId); ctx.strokeStyle = currentSkin.color; ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.lineJoin = "round";
                if (currentSkin.type === 'neon') { ctx.shadowBlur = 15; ctx.shadowColor = currentSkin.color; }
                ctx.beginPath();
                if (currentSkin.special === 'laser' || currentSkin.type === 'sharp') { ctx.beginPath(); ctx.moveTo(-10, -8); ctx.lineTo(0, 15); ctx.lineTo(10, -8); ctx.stroke(); } 
                else if (currentSkin.special === 'blackhole') { ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI * 2); ctx.fillStyle = '#000'; ctx.fill(); ctx.stroke(); } 
                else { ctx.beginPath(); if (this.targetObj) { ctx.arc(0, 4, 8, 0, Math.PI * 2); ctx.stroke(); } else { ctx.arc(0, 0, 12, 0, Math.PI, false); ctx.stroke(); } }
                ctx.restore();
            }
        }

        class Mole {
            constructor() {
                this.active = false; this.caught = false; this.collected = false;
                this.x = 0; this.y = 0; this.speed = 2; this.direction = 1; 
                this.weight = 5; this.value = 800; this.type = 'mole';
            }
            spawn() {
                this.active = true; this.caught = false; this.collected = false;
                this.direction = Math.random() < 0.5 ? 1 : -1;
                this.y = 180 + Math.random() * (canvas.height - 250);
                this.speed = 1.5 + (gameState.level * 0.1);
                this.x = this.direction === 1 ? -50 : canvas.width + 50;
            }
            update() {
                if (!this.active || this.caught) return;
                this.x += this.speed * this.direction;
                if ((this.direction === 1 && this.x > canvas.width + 50) || (this.direction === -1 && this.x < -50)) this.active = false; 
            }
            draw() {
                if (!this.active || this.collected) return;
                ctx.save(); ctx.translate(this.x, this.y); if (this.direction === -1) ctx.scale(-1, 1);
                if (assets.mole.loaded) {
                    ctx.drawImage(assets.mole.img, 0, 0, 40, 30);
                } else {
                    ctx.fillStyle = '#795548'; ctx.beginPath(); ctx.ellipse(0, 0, 20, 15, 0, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(15, -5, 10, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#00FFFF'; ctx.beginPath(); ctx.moveTo(15, 5); ctx.lineTo(25, 5); ctx.lineTo(20, 15); ctx.fill();
                }
                ctx.restore();
            }
        }

        class MineObject {
            constructor(type, x, y) {
                this.type = type; this.x = x; this.y = y; this.caught = false; this.collected = false;
                let inflation = 1 + (gameState.level * 0.1);
                switch(type) {
                    case 'gold': 
                        this.radius = 15 + Math.random() * 20; 
                        this.value = Math.floor((this.radius * 12) * inflation); 
                        this.weight = this.radius * 1.5; 
                        break;
                    case 'rock': 
                        let sizeRoll = Math.random();
                        if (sizeRoll < 0.4) { this.radius = 20 + Math.random() * 8; this.damage = 30; } 
                        else if (sizeRoll < 0.8) { this.radius = 29 + Math.random() * 9; this.damage = 50; } 
                        else { this.radius = 39 + Math.random() * 11; this.damage = 100; }
                        this.value = Math.floor((this.radius * 0.5) * inflation); 
                        this.weight = this.radius * 3.5; 
                        break;
                    case 'diamond': 
                        this.radius = 12; 
                        this.value = Math.floor(650 * inflation); 
                        this.weight = 5; 
                        break;
                    case 'tnt':
                        this.radius = 18;
                        this.damage = 150; // High damage
                        this.weight = 10;
                        break;
                }
            }

            draw() {
                if (this.collected) return;
                ctx.save();
                ctx.translate(this.x, this.y);

                // Asset varsa √ßiz, yoksa procedural
                if (this.type === 'gold' && assets.gold.loaded) {
                    ctx.drawImage(assets.gold.img, -this.radius, -this.radius, this.radius*2, this.radius*2);
                } else if (this.type === 'rock' && assets.rock.loaded) {
                    ctx.drawImage(assets.rock.img, -this.radius, -this.radius, this.radius*2, this.radius*2);
                } else if (this.type === 'diamond' && assets.diamond.loaded) {
                    ctx.drawImage(assets.diamond.img, -this.radius, -this.radius, this.radius*2, this.radius*2);
                } else {
                    if (this.type === 'rock') {
                        ctx.fillStyle = '#7f8c8d'; ctx.beginPath(); ctx.moveTo(-this.radius, -this.radius/2); ctx.lineTo(0, -this.radius); ctx.lineTo(this.radius, -this.radius*0.7); ctx.lineTo(this.radius*0.8, this.radius*0.8); ctx.lineTo(-this.radius*0.6, this.radius); ctx.closePath(); ctx.fill();
                        ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-this.radius * 0.3, 0); ctx.lineTo(this.radius * 0.2, this.radius * 0.2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, -this.radius * 0.4); ctx.lineTo(this.radius * 0.1, -this.radius * 0.1); ctx.stroke();
                    } else if (this.type === 'gold') {
                        let s = this.radius * 0.8; ctx.fillStyle = '#B8860B'; ctx.beginPath(); ctx.moveTo(-s, -s/2); ctx.lineTo(s, -s/2); ctx.lineTo(s*0.8, s); ctx.lineTo(-s*0.8, s); ctx.fill();
                        ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.moveTo(-s, -s/2); ctx.lineTo(s, -s/2); ctx.lineTo(s*0.7, -s); ctx.lineTo(-s*0.7, -s); ctx.fill();
                        ctx.fillStyle = '#DAA520'; ctx.beginPath(); ctx.moveTo(-s, -s/2); ctx.lineTo(s, -s/2); ctx.lineTo(s*0.8, s); ctx.lineTo(-s*0.8, s); ctx.fill();
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)'; ctx.beginPath(); ctx.moveTo(-s+2, -s/2+2); ctx.lineTo(0, s-2); ctx.lineTo(2, s-2); ctx.lineTo(-s+5, -s/2+2); ctx.fill();
                    } else if (this.type === 'diamond') {
                        ctx.fillStyle = '#00FFFF'; ctx.beginPath(); ctx.moveTo(0, -this.radius); ctx.lineTo(this.radius, 0); ctx.lineTo(0, this.radius); ctx.lineTo(-this.radius, 0); ctx.fill();
                        ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.moveTo(0, -this.radius/2); ctx.lineTo(this.radius/2, 0); ctx.lineTo(0, this.radius/2); ctx.lineTo(-this.radius/2, 0); ctx.fill();
                        ctx.shadowBlur = 10; ctx.shadowColor = '#00FFFF';
                    } else if (this.type === 'tnt') {
                         // TNT Varili
                         ctx.fillStyle = '#d32f2f'; // Kƒ±rmƒ±zƒ± g√∂vde
                         ctx.fillRect(-15, -20, 30, 40);
                         // ≈ûeritler
                         ctx.fillStyle = '#fbc02d'; // Sarƒ± ≈üeritler
                         ctx.fillRect(-15, -10, 30, 5);
                         ctx.fillRect(-15, 5, 30, 5);
                         // Yazƒ±
                         ctx.fillStyle = 'white';
                         ctx.font = 'bold 10px sans-serif';
                         ctx.textAlign = 'center';
                         ctx.fillText('TNT', 0, 3);
                         // Fitil
                         ctx.strokeStyle = '#5d4037';
                         ctx.lineWidth = 2;
                         ctx.beginPath();
                         ctx.moveTo(0, -20);
                         ctx.lineTo(5, -28);
                         ctx.stroke();
                         // Kƒ±vƒ±lcƒ±m
                         ctx.fillStyle = '#ffeb3b';
                         ctx.beginPath();
                         ctx.arc(5, -28, 2, 0, Math.PI*2);
                         ctx.fill();
                    }
                }
                ctx.restore();
            }
        }

        // --- GLOBAL DEƒûƒ∞≈ûKENLER ---
        hook = new Hook(); 
        miner = new Miner();
        mole = new Mole(); 

        // --- KAYIT & Sƒ∞STEM ---
        function saveGame() { try { localStorage.setItem('goldMinerSave_v9', JSON.stringify(gameState)); } catch(e) {} }
        function loadGame() {
            try { const saved = localStorage.getItem('goldMinerSave_v9'); if (saved) gameState = { ...defaultState, ...JSON.parse(saved) }; } catch(e) {}
        }
        function resetSave() { try { localStorage.removeItem('goldMinerSave_v9'); } catch(e){} location.reload(); }

        function getBoosterPrice(type) {
            let base = 0; if(type==='dynamite') base=200; if(type==='strength') base=300; if(type==='polish') base=150;
            return Math.floor(base * Math.pow(1.10, gameState.level - 1));
        }

        // --- MEN√úLER ---
        function showMainMenu() {
            ui.mainMenu.classList.remove('hidden'); ui.startScreen.classList.add('hidden'); ui.shopScreen.classList.add('hidden'); ui.pauseScreen.classList.add('hidden'); ui.miniGameScreen.classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            sessionState.inMenu = true;
            sessionState.isPaused = false;
            sessionState.inMiniGame = false;
            if (!gameState.tutorialSeen) { ui.tutorialScreen.classList.remove('hidden'); }
        }

        function closeTutorial() { ui.tutorialScreen.classList.add('hidden'); gameState.tutorialSeen = true; saveGame(); }

        function startGameFlow() {
            ui.mainMenu.classList.add('hidden');
            gameState.levelMoneyStart = 0; 
            sessionState.playingLevel = gameState.level;
            showStartScreen();
        }

        function showStartScreen() {
            sessionState.inMenu = true;
            ui.startScreen.classList.remove('hidden');
            document.getElementById('level-title').innerText = `SEVƒ∞YE ${sessionState.playingLevel}`;
            
            ui.preBoostersInfo.innerHTML = '';
            if (gameState.activeBoosters.dynamite) ui.preBoostersInfo.innerHTML += '<span title="Dinamit">üß®</span>';
            if (gameState.activeBoosters.strength) ui.preBoostersInfo.innerHTML += '<span title="G√º√ß">üí™</span>';
            if (gameState.activeBoosters.polish) ui.preBoostersInfo.innerHTML += '<span title="Cila">üíé</span>';

            ui.dynamiteHint.style.display = gameState.activeBoosters.dynamite ? 'block' : 'none';
        }

        function initLevel(lvl) {
            objects = []; particles = [];
            hook.state = 'swing'; hook.targetObj = null; hook.length = 50;
            mole.active = false; 
            
            let durability = getSkinDurability(gameState.currentSkinId);
            sessionState.currentHealth = durability; sessionState.maxHealth = durability;
            sessionState.storage = 0; sessionState.levelEnding = false; sessionState.inMenu = false; sessionState.inMiniGame = false;
            
            gameState.levelScore = 0;
            gameState.levelTarget = 400 + (lvl * 250); 
            
            updateUI(); saveGame();

            let count = Math.min(12 + lvl, 35);
            for(let i=0; i<count; i++) {
                let typeRand = Math.random();
                let type = 'rock';
                let rockProb = 0.3 + (lvl * 0.02); if (rockProb > 0.6) rockProb = 0.6;
                if (typeRand < rockProb) type = 'rock'; else if (typeRand < 0.85) type = 'gold'; else if (typeRand < 0.95 && lvl > 2) type = 'diamond'; else type = 'gold';
                
                // 10. Seviye ve √ºzeri TNT ≈üansƒ±
                if (lvl >= 10 && Math.random() < 0.1) {
                    type = 'tnt';
                }

                let ox = 50 + Math.random() * (canvas.width - 100); let oy = 150 + Math.random() * (canvas.height - 200);
                let safe = true; for(let o of objects) { if (Math.hypot(o.x - ox, o.y - oy) < 40) safe = false; }
                if(safe) objects.push(new MineObject(type, ox, oy));
            }
        }

        function createExplosion(x, y) {
            for(let i=0; i<15; i++) {
                particles.push({ x: x, y: y, vx: (Math.random()-0.5)*7, vy: (Math.random()-0.5)*7, life: 1.0, color: '#ff5722' });
            }
             for(let i=0; i<5; i++) {
                particles.push({ x: x, y: y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 1.0, color: '#ffeb3b' });
            }
        }

        function collectObject(obj) {
            if (obj.type === 'rock' || obj.type === 'tnt') {
                let damage = obj.damage || 30; 
                sessionState.currentHealth -= damage;
                let msg = obj.type === 'tnt' ? `TNT PATLADI! -${damage}` : `HASAR: -${damage}`;
                let color = obj.type === 'tnt' ? '#b71c1c' : '#e53935';
                
                showMessage(msg, color);
                
                if (sessionState.currentHealth <= 0) { sessionState.currentHealth = 0; loseLevel("Kanca par√ßalandƒ±!"); }
            } else {
                if (sessionState.storage >= gameState.maxStorage) { showMessage("DEPO TAMAMEN DOLU!", "red"); checkEnd(); return; }
                let val = obj.value;
                if (obj.type === 'diamond' && gameState.activeBoosters.polish) { val = Math.floor(val * 1.5); showMessage("Cila Bonusu!", "#00FFFF"); }
                if (obj.type === 'mole') { showMessage("FARE YAKALANDI!", "#00FFFF"); mole.active = false; mole.caught = false; } else { showMessage(`+$${val}`, "#ffd700"); }
                gameState.money += val; gameState.levelScore += val; sessionState.storage += obj.weight;
            }
            obj.collected = true; updateUI(); saveGame(); checkEnd();
        }

        function checkEnd() {
            if (sessionState.levelEnding) return;
            if (gameState.levelScore >= gameState.levelTarget) { winLevel(); return; }
            if (sessionState.currentHealth <= 0) return;
            
            let remainingCapacity = gameState.maxStorage - sessionState.storage;
            let valuableExists = objects.some(o => !o.collected && o.type !== 'rock' && o.type !== 'tnt');

            if (gameState.levelScore < gameState.levelTarget) {
                if (!valuableExists && !mole.active) { loseLevel("Maden t√ºkendi."); } 
                else if (sessionState.storage >= gameState.maxStorage) { loseLevel("Depo doldu."); }
            }
        }

        function winLevel(msg) {
            sessionState.levelEnding = true;
            gameState.activeBoosters = { dynamite: false, strength: false, polish: false };
            saveGame();
            if(msg) showMessage(msg, "#4CAF50");
            setTimeout(() => {
                // Eƒüer b√∂l√ºm 10'un katƒ±ysa (10, 20, 30...) Mini Game a√ß
                if (sessionState.playingLevel % 10 === 0) {
                    startMiniGame();
                } else {
                    openShop(false);
                }
            }, 1500);
        }

        function loseLevel(reason) {
            sessionState.levelEnding = true;
            gameState.activeBoosters = { dynamite: false, strength: false, polish: false };
            saveGame();
            setTimeout(() => {
                ui.shopScreen.classList.add('hidden');
                document.getElementById('game-over-screen').classList.remove('hidden');
                document.getElementById('game-over-reason').innerText = reason;
                document.getElementById('final-score').innerText = `Kasa: $${gameState.money}`;
            }, 1000);
        }

        // --- MINI GAME: M√úCEVHER AT√ñLYESƒ∞ ---
        function startMiniGame() {
            sessionState.inMiniGame = true;
            ui.miniGameScreen.classList.remove('hidden');
            ui.mgRewardShowcase.innerHTML = '<div style="font-size:50px;">üíé</div>';
            mg.active = true; mg.pos = 50; mg.dir = 1; mg.speed = 2.5 + (sessionState.playingLevel / 10); 
            mg.btn.disabled = false; mg.btn.innerText = "ƒ∞≈ûLE!"; mg.resultEl.innerText = "";
            requestAnimationFrame(miniGameLoop);
        }

        function miniGameLoop() {
            if (!mg.active) return;
            mg.pos += mg.speed * mg.dir;
            if (mg.pos > 100 || mg.pos < 0) mg.dir *= -1;
            mg.needleEl.style.left = mg.pos + '%';
            requestAnimationFrame(miniGameLoop);
        }

        function hitMiniGame() {
            if (!mg.active) return;
            mg.active = false;
            mg.btn.disabled = true;

            let bonus = 0; let text = ""; let color = "#fff"; let rewardType = "";
            if (mg.pos >= 40 && mg.pos <= 60) {
                bonus = 10000 * (sessionState.playingLevel); text = "EFSANEVƒ∞ KOLYE √úRETƒ∞LDƒ∞!"; color = "#4caf50"; rewardType = "necklace";
            } else if (mg.pos >= 25 && mg.pos <= 75) {
                bonus = 3000 * (sessionState.playingLevel); text = "G√úM√ú≈û Bƒ∞LEKLƒ∞K HAZIR!"; color = "#ffeb3b"; rewardType = "bracelet";
            } else {
                bonus = 1000; text = "BASƒ∞T K√úPE YAPILDI."; color = "#e53935"; rewardType = "earring";
            }
            ui.mgRewardShowcase.innerHTML = getRewardSVG(rewardType);
            bonus = Math.floor(bonus); gameState.money += bonus;
            mg.resultEl.innerText = `${text} (+$${bonus})`; mg.resultEl.style.color = color;
            saveGame();
            setTimeout(() => { ui.miniGameScreen.classList.add('hidden'); sessionState.inMiniGame = false; openShop(false); }, 2500);
        }
        
        document.getElementById('mg-hit-btn').onclick = hitMiniGame;

        function restartCurrentLevel() {
            gameState.money = gameState.levelMoneyStart; 
            gameState.levelScore = 0; 
            ui.pauseScreen.classList.add('hidden'); sessionState.isPaused = false;
            initLevel(sessionState.playingLevel); 
            // loop √ßaƒürƒ±sƒ± kaldƒ±rƒ±ldƒ±
        }

        function updateUI() {
            ui.money.innerText = gameState.money;
            ui.targetDisplay.innerText = `${gameState.levelScore} / ${gameState.levelTarget}`;
            ui.level.innerText = sessionState.playingLevel;
            
            let sPct = (sessionState.storage / gameState.maxStorage) * 100;
            let displayPct = Math.min(sPct, 100); 
            ui.storageTextMini.innerText = `${Math.floor(sPct)}%`; ui.storageBar.style.width = `${displayPct}%`;
            ui.storageBar.style.background = sPct > 90 ? '#f44336' : '#4caf50';

            let hPct = (sessionState.currentHealth / sessionState.maxHealth) * 100;
            ui.healthTextMini.innerText = `${Math.floor(sessionState.currentHealth)}`; ui.healthBar.style.width = `${Math.max(0, Math.min(hPct, 100))}%`;
            
            ui.activeBoosters.innerHTML = '';
            if (gameState.activeBoosters.dynamite) ui.activeBoosters.innerHTML += '<div class="booster-icon" title="Dinamit Hazƒ±r">üß®</div>';
            if (gameState.activeBoosters.strength) ui.activeBoosters.innerHTML += '<div class="booster-icon" title="G√º√ßl√º √áekim">üí™</div>';
            if (gameState.activeBoosters.polish) ui.activeBoosters.innerHTML += '<div class="booster-icon" title="Deƒüerli Elmas">üíé</div>';
        }

        function openShop(fromMenu = false) {
            sessionState.isShopping = true; sessionState.inMenu = true;
            sessionState.shopMode = fromMenu ? 'menu' : 'level';
            let nextTarget = Math.floor(400 + (sessionState.playingLevel * 250)); 
            if (fromMenu) { ui.shopTitle.innerText = "MARKET"; ui.shopMsg.innerText = `C√ºzdan: $${gameState.money}`; } 
            else { ui.shopTitle.innerText = `SEVƒ∞YE ${sessionState.playingLevel} TAMAMLANDI!`; ui.shopMsg.innerText = `C√ºzdan: $${gameState.money} - Sonraki Hedef: ${nextTarget} Puan`; }
            ui.pricePower.innerText = `$${gameState.prices.power}`; ui.priceStorage.innerText = `$${gameState.prices.storage}`;
            const nextBtn = document.getElementById('next-level-btn');
            if (fromMenu) nextBtn.innerText = "KAPAT"; else nextBtn.innerText = "SONRAKƒ∞ SEVƒ∞YE >>";
            ui.shopScreen.classList.remove('hidden'); saveGame(); renderShopItems(); updateBoosterButtons();
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.shop-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function renderShopItems() {
            ui.skinGrid.innerHTML = '';
            hookSkins.forEach(skin => {
                let isOwned = gameState.unlockedSkins.includes(skin.id);
                let btnText = isEquipped = gameState.currentSkinId === skin.id ? "KU≈ûANILDI" : (isOwned ? "KU≈ûAN" : "SATIN AL");
                let btnClass = isEquipped === "KU≈ûANILDI" ? "buy-btn equipped" : "buy-btn";
                let disabled = !isOwned && gameState.money < skin.price;
                ui.skinGrid.innerHTML += `<div class="item-card ${isOwned ? 'purchased' : ''}"><div class="item-icon">${getHookSVG(skin.type, skin.color)}</div><div class="item-name">${skin.name}</div><div class="item-desc">Dayanƒ±klƒ±lƒ±k: ${skin.durability}</div><div class="item-price">${isOwned ? 'Sahipsin' : '$'+skin.price}</div><button class="${btnClass}" ${disabled ? 'disabled' : ''} onclick="handleHookSkinClick('${skin.id}')">${btnText}</button></div>`;
            });
            ui.minerSkinGrid.innerHTML = '';
            minerSkins.forEach(skin => {
                let isOwned = gameState.unlockedMinerSkins.includes(skin.id);
                let btnText = isEquipped = gameState.currentMinerSkinId === skin.id ? "KU≈ûANILDI" : (isOwned ? "KU≈ûAN" : "SATIN AL");
                let btnClass = isEquipped === "KU≈ûANILDI" ? "buy-btn equipped" : "buy-btn";
                let disabled = !isOwned && gameState.money < skin.price;
                ui.minerSkinGrid.innerHTML += `<div class="item-card ${isOwned ? 'purchased' : ''}"><div class="item-icon">${getMinerSVG(skin.shirt, skin.hat)}</div><div class="item-name">${skin.name}</div><div class="item-price">${isOwned ? 'Sahipsin' : '$'+skin.price}</div><button class="${btnClass}" ${disabled ? 'disabled' : ''} onclick="handleMinerSkinClick('${skin.id}')">${btnText}</button></div>`;
            });
        }

        window.handleHookSkinClick = function(skinId) {
            let skin = hookSkins.find(s => s.id === skinId);
            if (gameState.unlockedSkins.includes(skinId)) { gameState.currentSkinId = skinId; }
            else { if (gameState.money >= skin.price) { gameState.money -= skin.price; gameState.unlockedSkins.push(skinId); gameState.currentSkinId = skinId; updateUI(); } }
            saveGame(); renderShopItems();
        }

        window.handleMinerSkinClick = function(skinId) {
            let skin = minerSkins.find(s => s.id === skinId);
            if (gameState.unlockedMinerSkins.includes(skinId)) { gameState.currentMinerSkinId = skinId; }
            else { if (gameState.money >= skin.price) { gameState.money -= skin.price; gameState.unlockedMinerSkins.push(skinId); gameState.currentMinerSkinId = skinId; updateUI(); } }
            saveGame(); renderShopItems();
        }

        function buyBooster(type) {
            let price = getBoosterPrice(type);
            if (gameState.money >= price && !gameState.activeBoosters[type]) {
                gameState.money -= price; gameState.activeBoosters[type] = true; updateBoosterButtons(); updateUI(); saveGame();
            }
        }

        function updateBoosterButtons() {
            setBtnState('btn-boost-dynamite', 'dynamite', getBoosterPrice('dynamite'));
            setBtnState('btn-boost-strength', 'strength', getBoosterPrice('strength'));
            setBtnState('btn-boost-polish', 'polish', getBoosterPrice('polish'));
            ui.priceDynamite.innerText = `$${getBoosterPrice('dynamite')}`; ui.priceStrength.innerText = `$${getBoosterPrice('strength')}`; ui.pricePolish.innerText = `$${getBoosterPrice('polish')}`;
        }

        function setBtnState(btnId, type, price) {
            const btn = document.getElementById(btnId);
            if (gameState.activeBoosters[type]) { btn.innerText = "ALINDI"; btn.className = "buy-btn equipped"; btn.disabled = true; } 
            else { btn.innerText = "SATIN AL"; btn.className = "buy-btn"; btn.disabled = gameState.money < price; }
        }

        function openMap() { sessionState.isMapOpen = true; ui.mapScreen.classList.remove('hidden'); renderMap(); }
        function closeMap() { sessionState.isMapOpen = false; ui.mapScreen.classList.add('hidden'); }
        function startLevelFromMap(lvl) {
            sessionState.playingLevel = lvl; closeMap(); ui.mainMenu.classList.add('hidden'); ui.pauseScreen.classList.add('hidden'); sessionState.isPaused = false; gameState.levelMoneyStart = gameState.money; showStartScreen();
        }
        function renderMap() { 
            ui.mapContent.innerHTML = '';
            let endLvl = gameState.level + 5;
            for (let i = endLvl; i >= 1; i--) {
                const node = document.createElement('div'); node.className = 'map-node'; node.innerText = i;
                if (i <= gameState.level) { node.classList.add('completed'); node.onclick = () => startLevelFromMap(i); } 
                else if (i === gameState.level) { node.classList.add('current'); node.id = 'current-level-node'; node.onclick = () => startLevelFromMap(i); } 
                else node.style.opacity = "0.5";
                if (i === sessionState.playingLevel) { node.style.border = "3px solid #00FFFF"; node.id = 'current-playing-node'; }
                ui.mapContent.appendChild(node);
            }
            setTimeout(() => { const c = document.getElementById('current-playing-node') || document.getElementById('current-level-node'); if(c) c.scrollIntoView({block:"center"}); }, 100);
        }

        function initListeners() {
            document.getElementById('btn-boost-dynamite').onclick = () => buyBooster('dynamite');
            document.getElementById('btn-boost-strength').onclick = () => buyBooster('strength');
            document.getElementById('btn-boost-polish').onclick = () => buyBooster('polish');

            document.getElementById('play-btn').onclick = startGameFlow;
            document.getElementById('main-reset-btn').onclick = resetSave;
            document.getElementById('main-market-btn').onclick = () => openShop(true);
            document.getElementById('tutorial-btn').onclick = () => ui.tutorialScreen.classList.remove('hidden');
            document.getElementById('close-tutorial-btn').onclick = closeTutorial;
            document.getElementById('pause-btn').onclick = () => { if (!sessionState.inMenu && !sessionState.levelEnding && !sessionState.inMiniGame) { sessionState.isPaused = true; ui.pauseScreen.classList.remove('hidden'); } };
            document.getElementById('resume-btn').onclick = () => { sessionState.isPaused = false; ui.pauseScreen.classList.add('hidden'); };
            document.getElementById('pause-restart-btn').onclick = restartCurrentLevel; 
            document.getElementById('main-menu-btn').onclick = () => { ui.pauseScreen.classList.add('hidden'); showMainMenu(); };
            
            document.getElementById('map-btn-start').onclick = openMap;
            document.getElementById('map-btn-pause').onclick = openMap;
            document.getElementById('close-map-btn').onclick = closeMap;

            document.getElementById('btn-power').onclick = () => { if (gameState.money >= gameState.prices.power) { gameState.money -= gameState.prices.power; gameState.hookSpeed *= 1.1; gameState.hookPower *= 1.1; gameState.prices.power = Math.floor(gameState.prices.power * 1.4); updateUI(); openShop(sessionState.shopMode === 'menu'); } };
            document.getElementById('btn-storage').onclick = () => { if (gameState.money >= gameState.prices.storage) { gameState.money -= gameState.prices.storage; gameState.maxStorage += 20; gameState.prices.storage = Math.floor(gameState.prices.storage * 1.4); updateUI(); openShop(sessionState.shopMode === 'menu'); } };
            
            document.getElementById('next-level-btn').onclick = () => {
                ui.shopScreen.classList.add('hidden');
                if (sessionState.shopMode === 'menu') { sessionState.isShopping = false; showMainMenu(); } 
                else {
                    if (sessionState.playingLevel === gameState.level) gameState.level++;
                    sessionState.playingLevel++;
                    gameState.levelMoneyStart = gameState.money; 
                    sessionState.isShopping = false;
                    showStartScreen(); 
                }
            };
            document.getElementById('start-level-btn').onclick = () => {
                ui.startScreen.classList.add('hidden');
                initLevel(sessionState.playingLevel); 
                if (!gameLoopRunning) { gameLoopRunning = true; loop(); }
            };
            document.getElementById('restart-level-btn').onclick = () => {
                document.getElementById('game-over-screen').classList.add('hidden');
                showStartScreen();
            };
            document.getElementById('game-over-main-btn').onclick = () => {
                document.getElementById('game-over-screen').classList.add('hidden');
                showMainMenu();
            };
        }

        window.addEventListener('load', () => {
            loadGame(); resize();
            window.addEventListener('resize', resize);
            initListeners(); showMainMenu(); 
        });

        function loop() {
            requestAnimationFrame(loop);
            if (sessionState.isPaused || sessionState.isMapOpen || sessionState.inMenu || sessionState.inMiniGame) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, canvas.width, 110);
            ctx.fillStyle = '#5D4037'; ctx.fillRect(0, 110, canvas.width, canvas.height);
            ctx.fillStyle = '#333'; ctx.fillRect(canvas.width/2 - 25, 50, 50, 60); 
            
            miner.update(); miner.draw();
            if (!mole.active && !mole.caught && Math.random() < 0.001) mole.spawn();
            mole.update(); mole.draw();
            objects.forEach(o => o.draw());
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
                if(p.life <= 0) particles.splice(i, 1);
            }
            hook.update(); hook.draw();
        }

        function inputAction(e) {
            if(e.type === 'touchstart') e.preventDefault(); 
            if (sessionState.inMenu || sessionState.levelEnding || sessionState.isPaused || sessionState.isMapOpen || sessionState.inMiniGame) return;

            const rect = canvas.getBoundingClientRect();
            let clientX = e.clientX; let clientY = e.clientY;
            if(e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
            const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
            const x = (clientX - rect.left) * scaleX; const y = (clientY - rect.top) * scaleY;

            if (gameState.activeBoosters.dynamite) {
                for (let i = 0; i < objects.length; i++) {
                    let o = objects[i];
                    if (!o.collected && o.type === 'rock') {
                        if (Math.hypot(o.x - x, o.y - y) < o.radius + 15) { 
                            createExplosion(o.x, o.y); objects.splice(i, 1);
                            gameState.activeBoosters.dynamite = false; showMessage("G√úM! Ta≈ü Yok Oldu", "#ff5722");
                            updateUI(); return; 
                        }
                    }
                }
            }
            if (hook.state === 'swing') hook.state = 'shoot'; 
        }
        canvas.addEventListener('mousedown', inputAction);
        canvas.addEventListener('touchstart', inputAction, {passive: false});

    </script>
</body>
</html>
